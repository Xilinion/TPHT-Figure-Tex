
% Local helper: add all object plots for a given case_id
% #1 = case_id
\newcommand{\AddAllObjectPlotsForCase}[1]{%
    % \htthree (object_id=6)
    \addplot[CuckooLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{6:6},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};

    % \htfour (object_id=7)
    \addplot[IcebergLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{7:7},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};

    % \htfive (object_id=15)
    \addplot[JunctionLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{15:15},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};

    % \htsix (object_id=24)
    \addplot[TBBLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{24:24},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};

    % \htone (object_id=17)
    \addplot[TPHTLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{17:17},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};

    % \httwo (object_id=23)
    \addplot[BlastLineStyle] table[
            x=space_efficiency,
            y=throughput_millions,
            restrict expr to domain={\thisrow{object_id}}{23:23},
            restrict expr to domain={\thisrow{case_id}}{#1:#1}
        ] {\throughputdata};
}

% Common axis style for all space efficiency plots
\pgfplotsset{
    spaceeff axis/.style={
            width=6.2cm,
            height=3.7cm,
            xlabel={Space Efficiency},
            xmin=0,
            ymin=0,
            grid=major,
            grid style={gray!30},
            tick label style={font=\small},
            label style={font=\small},
            scaled ticks=true,
            tick label style={/pgf/number format/fixed,/pgf/number format/precision=2},
            xtick distance=0.2,
            % ytick distance=10,
            minor tick num=1
        },
    spaceeff axis with ylabel/.style={
            spaceeff axis,
            ylabel={Throughput (M/s)}
        }
}

% Helper: create a subplot for a given case
% #1 = case_id, #2 = position (e.g., [b]{0.45\textwidth}), #3 = extra options for legend
\newcommand{\CreateSpaceEffSubplot}[3]{%
    \begin{subfigure}#2
        \centering
        \begin{tikzpicture}
            \begin{axis}[spaceeff axis, #3]
                \AddAllObjectPlotsForCase{#1}
            \end{axis}
        \end{tikzpicture}
        \caption{Case #1}
    \end{subfigure}%
}

\begin{figure*}[h]
    \centering
    \begin{minipage}{0.95\linewidth}
        \centering

        % Legend above figures in 1x5 layout
        {\pgfplotslegendfromname{spaceeff-legend}}

        % \vspace{0.5cm}

        % Case 1 with legend definition and y-label
        \begin{subfigure}[b]{0.35\textwidth}
            \centering
            \begin{tikzpicture}
                \begin{axis}[spaceeff axis with ylabel, legend to name={spaceeff-legend}, legend entries={\htthree, \htfour, \htfive, \htsix, \htone, \httwo}, legend cell align=left, legend style={draw=none, legend columns=6, /tikz/every even column/.append style={column sep=0.5cm}}]
                    \AddAllObjectPlotsForCase{1}
                \end{axis}
            \end{tikzpicture}
            \caption{Insertion}\label{fig:throughput_space_efficiency/insertion}
        \end{subfigure}%
        % Case 9 (no y-label)
        \begin{subfigure}[b]{0.32\textwidth}
            \centering
            \begin{tikzpicture}
                \begin{axis}[spaceeff axis]
                    \AddAllObjectPlotsForCase{9}
                \end{axis}
            \end{tikzpicture}
            \caption{Positive Query}\label{fig:throughput_space_efficiency/positive_query}
        \end{subfigure}%
        % Case 10 (no y-label)
        \begin{subfigure}[b]{0.32\textwidth}
            \centering
            \begin{tikzpicture}
                \begin{axis}[spaceeff axis]
                    \AddAllObjectPlotsForCase{10}
                \end{axis}
            \end{tikzpicture}
            \caption{Negative Query}\label{fig:throughput_space_efficiency/negative_query}
        \end{subfigure}
    \end{minipage}

    \caption{Throughput-space efficiency tradeoff across insertion and query workloads. Each curve shows how throughput and space efficiency vary with load factor, with rightmost points indicating maximum achievable space efficiency.}\label{fig:throughput_space_efficiency_cases}
\end{figure*}